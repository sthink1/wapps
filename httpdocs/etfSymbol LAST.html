<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ETF Symbols</title>

<style>
body {
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    margin: 0;
    background-color: #f4f4f4;
    padding-bottom: 40px;
}
.container {
    text-align: center;
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    width: 460px;
}
button {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 8px 16px;
    margin: 5px;
    border-radius: 4px;
    cursor: pointer;
}
button:hover { background-color: #45a049; }
input, select {
    padding: 6px;
    margin: 5px;
    width: 90%;
}
.status {
    font-size: 18px;
    font-weight: bold;
}
.message {
    margin-top: 10px;
    color: red;
}
footer {
    background-color: lightgray;
    height: 30px;
    padding-top: 5px;
    position: fixed;
    bottom: 0;
    width: 100%;
    text-align: center;
}
</style>
</head>

<body>
<div class="container">

<h2>Input New ETF Symbol</h2>

<select id="categorySelect"></select>
<br>

<input type="text" id="symbolInput" placeholder="Enter ETF Symbol (e.g. VOO)">
<br>

<button onclick="verifySymbol()">Verify</button>

<div id="verifyResult" class="status"></div>
<div id="symbolName"></div>

<br>

<button onclick="saveSymbol()">Save</button>
<button onclick="clearForm()">Clear</button>
<button onclick="goBack()">Back</button>

<div id="message" class="message"></div>

</div>

<footer>
ETF Module
</footer>

<script>

const API_BASE = "/api/etf";
const token = localStorage.getItem("token");

let verifiedData = null;

document.addEventListener("DOMContentLoaded", loadCategories);

async function loadCategories() {
    try {
        const res = await fetch(`${API_BASE}/categories`, {
            headers: { "Authorization": `Bearer ${token}` }
        });

        const data = await res.json();

        if (!res.ok) throw new Error(data.error);

        const select = document.getElementById("categorySelect");
        select.innerHTML = "";

        data.data.forEach(cat => {
            const option = document.createElement("option");
            option.value = cat.CategoryID;
            option.textContent = cat.CategoryName;
            select.appendChild(option);
        });

    } catch (err) {
        showMessage(err.message);
    }
}

async function verifySymbol() {

    const symbol = document.getElementById("symbolInput").value.trim().toUpperCase();
    if (!symbol) {
        showMessage("Enter a symbol first.");
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/verify-symbol`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ symbol })
        });

        const data = await res.json();

        if (!res.ok) throw new Error(data.error);

        verifiedData = data.data;

        const resultDiv = document.getElementById("verifyResult");
        const nameDiv = document.getElementById("symbolName");

        if (verifiedData.valid) {
            resultDiv.textContent = "✔ VALID";
            resultDiv.style.color = "green";
            nameDiv.textContent = verifiedData.name;
        } else {
            resultDiv.textContent = "✖ NOT FOUND";
            resultDiv.style.color = "red";
            nameDiv.textContent = "";
        }

        clearMessage();

    } catch (err) {
        showMessage(err.message);
    }
}

async function saveSymbol() {

    if (!verifiedData) {
        showMessage("Verify symbol first.");
        return;
    }

    const categoryID = document.getElementById("categorySelect").value;
    const symbol = document.getElementById("symbolInput").value.trim().toUpperCase();

    try {
        const res = await fetch(`${API_BASE}/symbols`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({
                categoryID,
                symbol,
                name: verifiedData.name,
                valid: verifiedData.valid
            })
        });

        const data = await res.json();

        if (!res.ok) throw new Error(data.error);

        alert("Symbol saved successfully.");
        clearForm();

    } catch (err) {
        showMessage(err.message);
    }
}

function clearForm() {
    document.getElementById("symbolInput").value = "";
    document.getElementById("verifyResult").textContent = "";
    document.getElementById("symbolName").textContent = "";
    verifiedData = null;
    clearMessage();
}

function showMessage(msg) {
    document.getElementById("message").textContent = msg;
}

function clearMessage() {
    document.getElementById("message").textContent = "";
}

function goBack() {
    window.location.href = "etf.html";
}

</script>
</body>
</html>
